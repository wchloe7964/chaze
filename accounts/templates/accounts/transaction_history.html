{% extends 'accounts/base.html' %}
{% load humanize %}

{% block title %}Transaction History - Chase Bank{% endblock %}
{% block page_title %}Transaction History{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button class="btn btn-sm btn-outline-primary" onclick="exportTransactions()">
        <i class="fas fa-download me-1"></i>Export
    </button>
    <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i>Print
    </button>
</div>
{% endblock %}

{% block content %}
<div class="card shadow">
    <div class="card-header">
        <h5 class="mb-0">Filter Transactions</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="account" class="form-label">Account</label>
                <select name="account" id="account" class="form-select">
                    <option value="all" {% if filters.account == 'all' %}selected{% endif %}>All Accounts</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}" {% if filters.account == account.id|stringformat:"s" %}selected{% endif %}>
                        {{ account.account_nickname }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="type" class="form-label">Type</label>
                <select name="type" id="type" class="form-select">
                    <option value="all" {% if filters.type == 'all' %}selected{% endif %}>All Types</option>
                    <option value="credit" {% if filters.type == 'credit' %}selected{% endif %}>Credits</option>
                    <option value="debit" {% if filters.type == 'debit' %}selected{% endif %}>Debits</option>
                    <option value="transfer" {% if filters.type == 'transfer' %}selected{% endif %}>Transfers</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="category" class="form-label">Category</label>
                <select name="category" id="category" class="form-select">
                    <option value="all" {% if filters.category == 'all' %}selected{% endif %}>All Categories</option>
                    {% for category_value, category_name in categories %}
                    <option value="{{ category_value }}" {% if filters.category == category_value %}selected{% endif %}>
                        {{ category_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="date" class="form-label">Time Period</label>
                <select name="date" id="date" class="form-select">
                    <option value="30" {% if filters.date == '30' %}selected{% endif %}>30 Days</option>
                    <option value="90" {% if filters.date == '90' %}selected{% endif %}>90 Days</option>
                    <option value="365" {% if filters.date == '365' %}selected{% endif %}>1 Year</option>
                    <option value="all" {% if filters.date == 'all' %}selected{% endif %}>All Time</option>
                </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-1"></i>Apply
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Transactions</h5>
        <span class="text-muted">{{ transactions|length }} transactions found</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Account</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th class="text-end">Amount</th>
                        <th class="text-end">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.date|date:"M d, Y" }}</td>
                        <td>
                            <small>{{ transaction.account.account_nickname }}</small>
                            <br>
                            <small class="text-muted">****{{ transaction.account.account_number|slice:"-4:" }}</small>
                        </td>
                        <td>
                            <div>
                                <strong>{{ transaction.description }}</strong>
                                {% if transaction.merchant %}
                                <br>
                                <small class="text-muted">{{ transaction.merchant }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">
                                {{ transaction.get_category_display }}
                            </span>
                        </td>
                        <td class="text-end {% if transaction.transaction_type == 'credit' %}text-success{% else %}text-danger{% endif %}">
                            {% if transaction.transaction_type == 'credit' %}+{% else %}-{% endif %}
                            ${{ transaction.amount|floatformat:2 }}
                        </td>
                        <td class="text-end">
                            ${{ transaction.balance_after|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No transactions match your filters</p>
                            <a href="?account=all&type=all&category=all&date=30" class="btn btn-outline-primary">
                                Clear Filters
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportTransactions() {
    // Simple CSV export functionality
    const table = document.getElementById('transactionsTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    for (let i = 0; i < rows.length; i++) {
        let row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            row.push(cols[j].innerText);
        }
        
        csv.push(row.join(','));
    }
    
    // Download CSV file
    const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
    const downloadLink = document.createElement('a');
    downloadLink.download = 'chase-transactions.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}
</script>
{% endblock %}