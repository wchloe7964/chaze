{% extends 'accounts/base.html' %}
{% load humanize %}

{% block title %}Account Statements - Chase Bank{% endblock %}
{% block page_title %}Account Statements{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button class="btn btn-sm btn-outline-primary" onclick="generateCustomStatement()">
        <i class="fas fa-calendar-alt me-1"></i>Custom Statement
    </button>
    <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
        <i class="fas fa-print me-1"></i>Print All
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Statement Period Selection -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Statements</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="account" class="form-label">Account</label>
                <select name="account" id="account" class="form-select" onchange="this.form.submit()">
                    <option value="all">All Accounts</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}" {% if selected_account == account.id|stringformat:"s" %}selected{% endif %}>
                        {{ account.account_nickname }} (****{{ account.account_number|slice:"-4:" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="year" class="form-label">Year</label>
                <select name="year" id="year" class="form-select" onchange="this.form.submit()">
                    {% for year in years %}
                    <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="month" class="form-label">Month</label>
                <select name="month" id="month" class="form-select" onchange="this.form.submit()">
                    <option value="all">All Months</option>
                    {% for month_num, month_name in months %}
                    <option value="{{ month_num }}" {% if selected_month == month_num %}selected{% endif %}>{{ month_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>

<!-- Available Statements -->
<div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-file-pdf me-2"></i>Available Statements</h5>
        <span class="text-muted">{{ statement_periods|length }} statements available</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Statement Period</th>
                        <th>Account</th>
                        <th>Opening Balance</th>
                        <th>Closing Balance</th>
                        <th>Transactions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for period in statement_periods %}
                    <tr>
                        <td>
                            <strong>{{ period.month }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ period.start_date|date:"M d" }} - {{ period.end_date|date:"M d, Y" }}
                            </small>
                        </td>
                        <td>
                            {% for account in accounts %}
                            <div class="mb-1">
                                <small>{{ account.account_nickname }}</small>
                                <br>
                                <small class="text-muted">****{{ account.account_number|slice:"-4:" }}</small>
                            </div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for account in accounts %}
                            <div class="mb-1">
                                <small>${{ account.balance|add:"-5000"|floatformat:2|intcomma }}</small>
                            </div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for account in accounts %}
                            <div class="mb-1">
                                <small>${{ account.balance|floatformat:2|intcomma }}</small>
                            </div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for account in accounts %}
                            <div class="mb-1">
                                <small>{{ forloop.counter|add:"20" }} transactions</small>
                            </div>
                            {% endfor %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="downloadStatement('{{ period.month }}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="previewStatement('{{ period.month }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="emailStatement('{{ period.month }}')">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-file-excel fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No statements available for the selected period</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Statement Archive Information -->
<div class="card shadow mt-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-archive me-2"></i>Statement Archive</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Archive Information</h6>
                    <ul class="mb-0 small">
                        <li>Statements are available for the past 7 years</li>
                        <li>PDF statements are generated on demand</li>
                        <li>You can request paper statements by contacting support</li>
                        <li>Statements are typically available by the 5th of each month</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h6>
                    <ul class="mb-0 small">
                        <li>Keep your statements for tax purposes</li>
                        <li>Review statements regularly for accuracy</li>
                        <li>Report any discrepancies within 60 days</li>
                        <li>Statements are encrypted for your security</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Statement Modal -->
<div class="modal fade" id="customStatementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Custom Statement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customStatementForm">
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Accounts</label>
                        {% for account in accounts %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="{{ account.id }}" id="account{{ account.id }}" checked>
                            <label class="form-check-label" for="account{{ account.id }}">
                                {{ account.account_nickname }} (****{{ account.account_number|slice:"-4:" }})
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="format">
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV Spreadsheet</option>
                            <option value="excel">Excel Format</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateStatement()">Generate Statement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function downloadStatement(period) {
    UIHelpers.showSuccess(`Downloading statement for ${period}...`);
    // Simulate download
    setTimeout(() => {
        UIHelpers.showSuccess('Statement downloaded successfully');
    }, 2000);
}

function previewStatement(period) {
    UIHelpers.showSuccess(`Opening preview for ${period}...`);
    // In real application, this would open a PDF preview
}

function emailStatement(period) {
    const email = prompt('Enter email address to send the statement:');
    if (email) {
        UIHelpers.showSuccess(`Statement for ${period} will be sent to ${email}`);
    }
}

function generateCustomStatement() {
    const modal = new bootstrap.Modal(document.getElementById('customStatementModal'));
    modal.show();
}

function generateStatement() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const format = document.getElementById('format').value;
    
    if (!startDate || !endDate) {
        UIHelpers.showError('Please select both start and end dates');
        return;
    }
    
    UIHelpers.showSuccess(`Generating ${format} statement from ${startDate} to ${endDate}...`);
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('customStatementModal'));
    modal.hide();
    
    // Simulate generation
    setTimeout(() => {
        UIHelpers.showSuccess('Custom statement generated successfully');
    }, 3000);
}

// Set default dates for custom statement
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
});
</script>
{% endblock %}